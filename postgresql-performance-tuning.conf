# PostgreSQL Configuration Recommendations for ERP System (200-300 Concurrent Users)
# Add these settings to your postgresql.conf file

# Connection Settings (Optimized for 200-300 users)
max_connections = 200                    # Reduced from 300 to match realistic load
shared_buffers = 512MB                   # Increased for better caching
effective_cache_size = 2GB              # Increased cache size assumption

# Memory Settings (Enhanced for concurrent load)
work_mem = 8MB                          # Increased for better sort/hash performance
maintenance_work_mem = 128MB            # Enhanced maintenance operations
temp_buffers = 16MB                     # Larger temporary buffers
shared_preload_libraries = 'pg_stat_statements'  # Enable query statistics

# WAL (Write-Ahead Logging) Settings
wal_buffers = 32MB                      # Increased WAL buffer size
checkpoint_completion_target = 0.9
max_wal_size = 4GB                      # Increased for better checkpoint spacing
min_wal_size = 160MB
wal_compression = on                    # Enable WAL compression

# Query Planning (SSD Optimized)
random_page_cost = 1.1
effective_io_concurrency = 300          # Increased for high concurrency
seq_page_cost = 1.0
cpu_tuple_cost = 0.01                  # Optimized for modern CPUs
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Connection and Session Management
tcp_keepalives_idle = 300               # Reduced for faster detection
tcp_keepalives_interval = 15
tcp_keepalives_count = 6
statement_timeout = 300000              # 5 minute timeout for long queries
lock_timeout = 30000                    # 30 second lock timeout

# Performance Monitoring and Statistics
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl
log_min_duration_statement = 500        # Log queries > 500ms
log_connections = off                   # Disabled for performance
log_disconnections = off
log_lock_waits = on
shared_preload_libraries = 'pg_stat_statements'

# Autovacuum Settings (Critical for ERP performance)
autovacuum = on
autovacuum_max_workers = 4              # Increased workers
autovacuum_naptime = 30s                # More frequent runs
autovacuum_vacuum_threshold = 100
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# Write Performance
synchronous_commit = on                 # Keep for ACID compliance
wal_sync_method = fdatasync
checkpoint_timeout = 10min
max_wal_senders = 3

# Memory and Cache Settings
default_statistics_target = 150         # Enhanced statistics
constraint_exclusion = partition
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# Background Writer Settings
bgwriter_delay = 100ms                  # More frequent writing
bgwriter_lru_maxpages = 200
bgwriter_lru_multiplier = 4.0

# Additional Performance Settings
hot_standby = on
max_standby_streaming_delay = 30s
wal_receiver_timeout = 60s
